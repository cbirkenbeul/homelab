---
- name: Create ghostfolio application directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"
  loop:
    - "{{ docker_dir }}/ghostfolio"

- name: Create ghostfolio data directory
  ansible.builtin.file:
    path: "{{ docker_dir }}/ghostfolio/data"
    state: directory
    mode: '0755'
    access_time: preserve
    modification_time: preserve

- name: Create ghostfolio redis container
  community.docker.docker_container:
    name: ghostfolio-redis
    image: redis:alpine3.18
    pull: true
    state: started
    recreate: true
    restart_policy: unless-stopped
    networks:
      - name: homelab

- name: Create ghostfolio application container
  community.docker.docker_container:
    name: ghostfolio-app
    image: ghcr.io/cbirkenbeul/ghostfolio:1.283.5
    pull: true
    state: started
    recreate: true
    restart_policy: unless-stopped
    env:
      DATABASE_URL: "postgresql://{{ SECRET_GHOSTFOLIO_DB_USER }}:{{ SECRET_GHOSTFOLIO_DB_PASSWORD }}@pgsql01.casalani.de:5432/ghostfolio?sslmode=prefer"
      REDIS_HOST: "ghostfolio-redis"
      REDIS_PORT: "6379"
      ACCESS_TOKEN_SALT: "{{ SECRET_GHOSTFOLIO_ACCESS_TOKEN }}"
      JWT_SECRET_KEY: "{{ SECRET_GHOSTFOLIO_JWT_SECRET_KEY }}"
      PORT: "3333"
      COMPOSE_PROJECT_NAME: "ghostfolio"
      HOST: "0.0.0.0"
      NODE_ENV: "production"
    networks:
      - name: homelab
    labels:
      traefik.enable: "true"
      traefik.http.routers.ghostfolio.rule: "Host(`ghostfolio.{{ SECRET_DOMAIN }}`)"
      traefik.http.routers.ghostfolio.entrypoints: "https"
      traefik.http.routers.ghostfolio.tls.certresolver: "letsencrypt"
      traefik.http.services.ghostfolio.loadbalancer.server.port: "3333"
