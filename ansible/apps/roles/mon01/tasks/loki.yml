---
- name: Create loki app directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"
  loop:
    - "{{ docker_dir }}/loki"

- name: Create loki data directory
  ansible.builtin.file:
    path: "{{ docker_dir }}/loki/loki"
    state: directory
    mode: '0777'
    access_time: preserve
    modification_time: preserve

- name: Create loki promtail directory
  ansible.builtin.file:
    path: "{{ docker_dir }}/loki/promtail"
    state: directory
    mode: '0777'
    access_time: preserve
    modification_time: preserve

- name: Create loki.yml file
  ansible.builtin.copy:
    content: |
      auth_enabled: false

      server:
        http_listen_port: 3100

      common:
        ring:
          instance_addr: 127.0.0.1
          kvstore:
            store: memberlist
        replication_factor: 1
        path_prefix: /loki # Update this accordingly, data will be stored here.

      schema_config:
        configs:
        - from: 2020-05-15
          store: boltdb-shipper
          object_store: s3
          schema: v11
          index:
            prefix: index_
            period: 24h

      storage_config:
        boltdb_shipper:
          active_index_directory: /loki/index
          cache_location: /loki/index_cache
          shared_store: aws
        aws:
          s3: https://minioadmin:minioadmin@s3.casalani.de/loki
          s3forcepathstyle: true

      compactor:
        working_directory: /loki/compactor
        shared_store: s3
        compaction_interval: 5m
    dest: "{{ docker_dir }}/loki/loki/local-config.yaml"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Create promtail.yml file
  ansible.builtin.copy:
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: 'http://192.168.10.101:3100/loki/api/v1/push'

      scrape_configs:
        - job_name: system
          static_configs:
            - targets:
                - localhost
              labels:
                job: varlogs
                __path__: /var/log/*log
        - job_name: syslog
          syslog:
            listen_address: 0.0.0.0:1514
            idle_timeout: 60s
            label_structured_data: yes
            labels:
              job: "syslog"
          relabel_configs:
            - source_labels: ['__syslog_message_hostname']
              target_label: 'host'
    dest: "{{ docker_dir }}/loki/promtail/config.yml"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Deploy loki with docker container
  community.docker.docker_container:
    name: loki
    image: grafana/loki:2.8.0
    restart_policy: unless-stopped
    state: started
    recreate: true
    networks:
      - name: homelab
    volumes:
      - "{{ docker_dir }}/loki/loki:/etc/loki"
    env:
      TZ: "{{ TZ }}"
    ports:
      - '3100:3100'

- name: Deploy promtail with docker container
  community.docker.docker_container:
    name: promtail
    image: grafana/promtail:2.8.0
    restart_policy: unless-stopped
    state: started
    recreate: true
    networks:
      - name: homelab
    volumes:
      - "{{ docker_dir }}/loki/promtail:/etc/promtail"
    env:
      TZ: "{{ TZ }}"
    ports:
      - '1514:1514'
